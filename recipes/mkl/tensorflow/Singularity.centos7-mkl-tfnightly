Bootstrap: shub
From: coreyjadams/larcv2-singularity:centos7-mkl-base

%help
Centos7 with mkl_dnn tensorflow
ML/DL packages  : tensorflow keras torch sc-learn
Sci.  packages  : numpy pandas sc-image matplotlib opencv-python
Basic python    : ipython jupyter yaml pygments six zmq wheel h5py tqdm mpi4py horovod
Development kit : g++/gcc cython nvcc libqt4-dev python-dev
Utility kit     : git wget emacs vim openssh-client openmpi

To start your container simply try
singularity exec THIS_CONTAINER.simg bash

To use GPUs, try
singularity exec THIS_CONTAINER.simg bash

%labels
Maintainer coreyjadams
Version centos7-mkldnn-tfnightly-mpich-root

#------------
# Global installation
#------------
%environment

%post

    # This builds tensorflow mkldnn from source

    mkdir tf_build/
    cd tf_build/
    git clone https://github.com/tensorflow/tensorflow.git
    cd tensorflow/
    git checkout master

    export JAVA_HOME=/usr/
    yes "" | ./configure

    # Build tensorflow: 
    bazel build --config=mkl -c opt --copt=-g --strip=never --copt='-Wl,rpath=/opt/gcc/7.3.0/snos' --copt=-mavx --copt=-mavx2 --copt=-mfma --copt=-mavx512f --copt=-mavx512pf --copt=-mavx512cd --copt=-mavx512er --copt='-mtune=knl' --copt="-DEIGEN_USE_VML" //tensorflow/tools/pip_package:build_pip_package

    # This step builds a pip wheel:
    mkdir ../tf_wheels
    bazel-bin/tensorflow/tools/pip_package/build_pip_package ../tf_wheels

    pip install --upgrade ../tf_wheels/tensorflow-master-cp27-cp27m-linux_x86_64.whl
